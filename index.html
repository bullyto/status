<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Apéro Status Admin</title>

  <meta name="theme-color" content="#0a121c" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="stylesheet" href="./styles.css" />

  <style>
    .ui-hide { display:none !important; }

    /* Cache les boutons pré-programmés (mais ils existent toujours) */
    #btnServiceOK,
    #btnPreviewPopup,
    #btnDownload { display:none !important; }

    /* Zone GitHub masquée par défaut, affichable via bouton Paramètre */
    .gh-zone { display:none; }
    .gh-zone.is-open { display:block; }

    .hint { font-size:12px; opacity:.72; margin-top:6px; line-height:1.25; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="icon-192.png" alt="Logo" />
        <div>
          <h1>Apéro Status Admin</h1>
          <div class="small">
            Pilote <code class="inline">status.json</code> (panne, incident, météo, sécurité)
            et publie directement sur APERO DE NUIT 66® et APERO CATALAN®.
          </div>
        </div>
      </div>

      <div class="badge">
        <span>État :</span> <b id="pActive">—</b>
        <span style="opacity:.5">•</span>
        <span>Mode :</span> <b id="pMode">—</b>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="hd"><div class="small">Contrôle</div></div>
        <div class="bd">

          <div class="row">
            <div>
              <label>Statut global</label>
              <select id="active">
                <option value="false">Inactif (aucun pop-up)</option>
                <option value="true">Actif (pop-up affiché)</option>
              </select>
            </div>
            <div>
              <label>Situation</label>
              <select id="mode"></select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Titre</label>
              <input id="title" placeholder="Ex: Service temporairement suspendu" />
            </div>
            <div>
              <label>Niveau</label>
              <select id="severity">
                <option value="info">info</option>
                <option value="warning">warning</option>
                <option value="danger">danger</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Message</label>
            <textarea id="message" placeholder="Texte affiché dans le pop-up..."></textarea>
          </div>

          <div style="margin-top:10px">
            <label>Image (chemin local dans le dépôt status)</label>
            <input id="image" placeholder="images/panne.png" />
          </div>

          <div class="hr"></div>

          <!-- Boutons techniques (présents mais cachés) -->
          <div class="btns">
            <button class="ok" id="btnServiceOK">Préparer “service OK”</button>
            <button class="secondary" id="btnPreviewPopup">Prévisualiser le pop-up</button>
            <button id="btnDownload">Télécharger status.json</button>
          </div>

          <div class="hr"></div>

          <!-- Zone GitHub (cachée/affichée via bouton Paramètre) -->
          <div class="gh-zone" style="margin-top:12px">
            <div class="row">
              <div>
                <label>Dépôt GitHub</label>
                <div style="display:flex;gap:10px">
                  <input id="ghOwner" placeholder="bullyto" />
                  <input id="ghRepo" placeholder="status" />
                </div>
              </div>
              <div>
                <label>Branch</label>
                <input id="ghBranch" placeholder="main" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Chemin du fichier</label>
              <input id="ghPath" placeholder="status.json" />
            </div>

            <div style="margin-top:10px">
              <label>Token GitHub</label>
              <input id="ghToken" type="password" autocomplete="off" placeholder="ghp_..." />
              <div class="hint">
                Stocké en local sur ce téléphone (localStorage) avec expiration automatique (6 mois).
                <br><span id="tokenStatus" style="opacity:.9">—</span>
              </div>
            </div>

            <div class="btns" style="margin-top:12px">
              <button class="secondary" id="btnSaveToken" type="button">Enregistrer le token</button>
              <button class="danger" id="btnClearToken" type="button">Supprimer le token</button>
            </div>

            <div class="hr" style="margin-top:14px"></div>
          </div>

          <!-- ✅ Publier + Paramètre côte à côte -->
          <div class="btns" style="margin-top:12px; display:flex; gap:10px;">
            <button id="btnPublish" style="flex:1;">Publier</button>
            <button id="btnToggleGh" type="button" class="secondary" style="min-width:140px;">Paramètre</button>
          </div>

        </div>
      </section>

      <!-- Aperçu -->
      <section class="card preview">
        <div class="hd"><div class="small">Aperçu</div></div>
        <div class="bd">
          <img id="pImg" alt="Aperçu image" src="./images/panne.png" />
          <div class="badge">
            <span>Dernière maj :</span> <b id="pUpdated">—</b>
            <span style="opacity:.5">•</span>
            <span>Severity :</span> <b id="pSev">—</b>
          </div>
          <div id="pTitle" style="margin-top:10px;font-weight:900;font-size:18px">—</div>
          <div id="pMsg" style="margin-top:6px;opacity:.85">—</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Preview overlay -->
  <div id="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:999999; align-items:center; justify-content:center; padding:16px;">
    <div style="max-width:520px; width:100%; background:#111; border:1px solid rgba(255,255,255,.12); border-radius:16px; overflow:hidden;">
      <img id="overlayImg" alt="" style="width:100%; display:block;">
      <div style="padding:14px 14px 16px;">
        <div id="overlayTitle" style="font-size:18px; font-weight:800; margin-bottom:6px;"></div>
        <div id="overlayMsg" style="font-size:14px; line-height:1.35;"></div>
        <button id="overlayBtn" style="margin-top:12px; width:100%;">OK</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Ton app existante -->
  <script src="./app.js"></script>

  <!-- ✅ Correctifs : toggle Paramètre + token localStorage 6 mois + preview hide si inactif -->
  <script>
  (function(){
    const LS_KEY = "gh_token_v1"; // JSON { token: string, exp: number }
    const SIX_MONTHS_MS = 1000 * 60 * 60 * 24 * 30 * 6;

    function toast(msg){
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.remove("show"), 2200);
    }

    function readToken(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj.token !== "string" || typeof obj.exp !== "number") return null;

        if (Date.now() > obj.exp) {
          localStorage.removeItem(LS_KEY);
          return null;
        }
        return obj;
      } catch(e){
        return null;
      }
    }

    function saveToken(token){
      const obj = { token, exp: Date.now() + SIX_MONTHS_MS };
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
      return obj;
    }

    function clearToken(){
      localStorage.removeItem(LS_KEY);
    }

    function setTokenStatus(obj){
      const s = document.getElementById("tokenStatus");
      if (!s) return;
      if (!obj) {
        s.textContent = "Aucun token enregistré.";
      } else {
        const expTxt = new Date(obj.exp).toLocaleString("fr-FR");
        s.textContent = "Token enregistré ✅ (expire le " + expTxt + ")";
      }
    }

    function syncPreviewVisibility(){
      const activeSel = document.getElementById("active");
      const previewCard = document.querySelector("section.card.preview");
      if (!activeSel || !previewCard) return;
      previewCard.style.display = (activeSel.value === "true") ? "" : "none";
    }

    function init(){
      const btnToggle = document.getElementById("btnToggleGh");
      const ghZone = document.querySelector(".gh-zone");
      const input = document.getElementById("ghToken");
      const btnSave = document.getElementById("btnSaveToken");
      const btnClear = document.getElementById("btnClearToken");
      const activeSel = document.getElementById("active");

      // Toggle Paramètre
      if (btnToggle && ghZone) {
        btnToggle.addEventListener("click", () => {
          ghZone.classList.toggle("is-open");
        });
      }

      // Remplissage auto si token valide
      const stored = readToken();
      if (input && stored) input.value = stored.token;
      setTokenStatus(stored);

      // Enregistrer
      if (btnSave && input) {
        btnSave.addEventListener("click", () => {
          const val = (input.value || "").trim();
          if (!val) {
            toast("Token vide : rien enregistré.");
            return;
          }
          const obj = saveToken(val);
          setTokenStatus(obj);
          toast("Token enregistré (6 mois) ✅");
        });
      }

      // Supprimer
      if (btnClear && input) {
        btnClear.addEventListener("click", () => {
          clearToken();
          input.value = "";
          setTokenStatus(null);
          toast("Token supprimé ✅");
        });
      }

      // Aperçu caché quand inactif
      if (activeSel) activeSel.addEventListener("change", syncPreviewVisibility);
      syncPreviewVisibility();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
  </script>

  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
  </script>
</body>
</html>
