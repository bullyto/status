<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ap√©ro Status Admin</title>

  <meta name="theme-color" content="#0a121c" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="stylesheet" href="./styles.css" />

  <style>
    /* Cache les boutons pr√©-programm√©s (mais ils existent toujours) */
    #btnServiceOK, #btnPreviewPopup, #btnDownload { display:none !important; }

    /* Zone GitHub masqu√©e par d√©faut, affichable via bouton Param√®tre */
    .gh-zone { display:none; }
    .gh-zone.is-open { display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="icon-192.png" alt="Logo" />
        <div>
          <h1>Ap√©ro Status Admin</h1>
          <div class="small">
            Pilote <code class="inline">status.json</code> (info / blocage commande)
            et publie directement sur APERO DE NUIT 66¬Æ et APERO CATALAN¬Æ.
          </div>
          <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap">
            <span class="pill">üïí <b id="clock">‚Äî</b></span>
            <span class="pill">üìÖ <b id="today">‚Äî</b></span>
          </div>
        </div>
      </div>

      <div class="badge">
        <span>√âtat :</span> <b id="pActive">‚Äî</b>
        <span style="opacity:.5">‚Ä¢</span>
        <span>Mode :</span> <b id="pMode">‚Äî</b>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="hd"><div class="small">Contr√¥le</div></div>
        <div class="bd">

          <div class="row">
            <div>
              <label>Statut global</label>
              <select id="active">
                <option value="false">Inactif (aucun pop-up)</option>
                <option value="true">Actif (pop-up affich√©)</option>
              </select>
            </div>
            <div>
              <label>Mode</label>
              <select id="mode"></select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Titre</label>
              <input id="title" placeholder="Ex: Info importante / Service indisponible" />
            </div>
            <div>
              <label>Niveau</label>
              <select id="severity">
                <option value="info">info</option>
                <option value="warning">warning</option>
              </select>
              <div class="hint">Seulement 2 niveaux : <b>info</b> (OK apr√®s 5s) ou <b>warning</b> (commande bloqu√©e).</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Message</label>
            <textarea id="message" placeholder="Texte affich√© dans le pop-up..."></textarea>
          </div>

          <div style="margin-top:10px">
            <label>Image (chemin relatif)</label>
            <input id="image" placeholder="images/panne.png" />
          </div>

          <div class="hr"></div>

          <!-- R√©glage mode INFO -->
          <div id="infoBox" class="card" style="border-radius:14px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
            <div class="bd" style="padding:12px">
              <div style="font-weight:800; margin-bottom:8px;">Mode info</div>
              <div class="row">
                <div>
                  <label>D√©lai avant ‚ÄúOK j‚Äôai compris‚Äù</label>
                  <input id="okDelay" type="number" min="0" step="1" placeholder="5" />
                  <div class="hint">Ex: 5 = le bouton OK est bloqu√© 5 secondes avant de fermer le pop-up.</div>
                </div>
                <div>
                  <label>(auto)</label>
                  <input disabled value="Le pop-up se ferme ensuite et la commande reste possible." />
                </div>
              </div>
            </div>
          </div>

          <!-- R√©glage mode WARNING -->
          <div id="warningBox" class="card ui-hide" style="margin-top:10px; border-radius:14px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10); box-shadow:none;">
            <div class="bd" style="padding:12px">
              <div style="font-weight:800; margin-bottom:8px;">Mode warning (blocage commande)</div>

              <div class="row">
                <div>
                  <label>Activer un horaire de blocage</label>
                  <select id="schedEnabled">
                    <option value="false">Non (bloque tout le temps)</option>
                    <option value="true">Oui (bloque seulement sur plage horaire)</option>
                  </select>
                  <div class="hint">Si ‚ÄúOui‚Äù, tu choisis jours + heures. Si ‚ÄúNon‚Äù, la commande est bloqu√©e 24/24.</div>
                </div>
                <div>
                  <label>Message si clic sur ‚ÄúOK j‚Äôai compris‚Äù</label>
                  <input id="warningClickMsg" placeholder="Impossible de commander pour le moment." />
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <div>
                  <label>Heure d√©but</label>
                  <input id="schedStart" type="time" value="19:00" />
                </div>
                <div>
                  <label>Heure fin</label>
                  <input id="schedEnd" type="time" value="06:00" />
                </div>
              </div>

              <div style="margin-top:10px">
                <label>Jours</label>
                <div class="weekdays" id="schedDays">
                  <label><input type="checkbox" value="1" />Lun</label>
                  <label><input type="checkbox" value="2" />Mar</label>
                  <label><input type="checkbox" value="3" />Mer</label>
                  <label><input type="checkbox" value="4" />Jeu</label>
                  <label><input type="checkbox" value="5" />Ven</label>
                  <label><input type="checkbox" value="6" />Sam</label>
                  <label><input type="checkbox" value="0" />Dim</label>
                </div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- Zone GitHub (cach√©e/affich√©e via bouton Param√®tre) -->
          <div class="gh-zone" style="margin-top:12px">
            <div class="row">
              <div>
                <label>D√©p√¥t GitHub</label>
                <div style="display:flex;gap:10px">
                  <input id="ghOwner" placeholder="bullyto" />
                  <input id="ghRepo" placeholder="status" />
                </div>
              </div>
              <div>
                <label>Branch</label>
                <input id="ghBranch" placeholder="main" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Chemin du fichier</label>
              <input id="ghPath" placeholder="status.json" />
            </div>

            <div style="margin-top:10px">
              <label>Token GitHub</label>
              <input id="ghToken" type="password" autocomplete="off" placeholder="ghp_..." />
              <div class="hint">
                Stock√© en local sur ce t√©l√©phone avec expiration automatique (6 mois).
                <br><span id="tokenStatus" style="opacity:.9">‚Äî</span>
              </div>
            </div>

            <div class="btns" style="margin-top:12px">
              <button class="secondary" id="btnSaveToken" type="button">Enregistrer le token</button>
              <button class="danger" id="btnClearToken" type="button">Supprimer le token</button>
            </div>

            <div class="hr" style="margin-top:14px"></div>
          </div>

          <!-- ‚úÖ Publier + Param√®tre c√¥te √† c√¥te -->
          <div class="btns" style="margin-top:12px; display:flex; gap:10px;">
            <button id="btnPublish" style="flex:1;">Publier</button>
            <button id="btnToggleGh" type="button" class="secondary" style="min-width:140px;">Param√®tre</button>
          </div>

        </div>
      </section>

      <!-- Aper√ßu -->
      <section class="card preview">
        <div class="hd"><div class="small">Aper√ßu</div></div>
        <div class="bd">
          <img id="pImg" alt="Aper√ßu image" src="./images/panne.png" />
          <div class="badge">
            <span>Derni√®re maj :</span> <b id="pUpdated">‚Äî</b>
            <span style="opacity:.5">‚Ä¢</span>
            <span>Severity :</span> <b id="pSev">‚Äî</b>
          </div>
          <div id="pTitle" style="margin-top:10px;font-weight:900;font-size:18px">‚Äî</div>
          <div id="pMsg" style="margin-top:6px;opacity:.85">‚Äî</div>
          <div id="pExtra" class="small" style="margin-top:10px; opacity:.8"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script src="./app.js"></script>

  <!-- Token localStorage 6 mois + toggle Param√®tre -->
  <script>
  (function(){
    const LS_KEY = "gh_token_v1"; // JSON { token: string, exp: number }
    const SIX_MONTHS_MS = 1000 * 60 * 60 * 24 * 30 * 6;

    function toast(msg){
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.remove("show"), 2200);
    }

    function readToken(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj.token !== "string" || typeof obj.exp !== "number") return null;
        if (Date.now() > obj.exp) {
          localStorage.removeItem(LS_KEY);
          return null;
        }
        return obj;
      } catch(e){
        return null;
      }
    }

    function saveToken(token){
      const obj = { token, exp: Date.now() + SIX_MONTHS_MS };
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
      return obj;
    }

    function clearToken(){ localStorage.removeItem(LS_KEY); }

    function setTokenStatus(obj){
      const s = document.getElementById("tokenStatus");
      if (!s) return;
      if (!obj) s.textContent = "Aucun token enregistr√©.";
      else s.textContent = "Token enregistr√© ‚úÖ (expire le " + new Date(obj.exp).toLocaleString("fr-FR") + ")";
    }

    function init(){
      const btnToggle = document.getElementById("btnToggleGh");
      const ghZone = document.querySelector(".gh-zone");
      const input = document.getElementById("ghToken");
      const btnSave = document.getElementById("btnSaveToken");
      const btnClear = document.getElementById("btnClearToken");

      if (btnToggle && ghZone) btnToggle.addEventListener("click", () => ghZone.classList.toggle("is-open"));

      const stored = readToken();
      if (input && stored) input.value = stored.token;
      setTokenStatus(stored);

      if (btnSave && input) btnSave.addEventListener("click", () => {
        const val = (input.value || "").trim();
        if (!val) return toast("Token vide : rien enregistr√©.");
        const obj = saveToken(val);
        setTokenStatus(obj);
        toast("Token enregistr√© (6 mois) ‚úÖ");
      });

      if (btnClear && input) btnClear.addEventListener("click", () => {
        clearToken();
        input.value = "";
        setTokenStatus(null);
        toast("Token supprim√© ‚úÖ");
      });
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
    else init();
  })();
  </script>

  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
  }
  </script>
</body>
</html>
