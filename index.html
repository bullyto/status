<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Apéro Status Admin</title>

  <meta name="theme-color" content="#0a121c" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="stylesheet" href="./styles.css" />

  <style>
    /* On garde TOUT pour que app.js fonctionne, mais on masque l’affichage */
    .ui-hide { display:none !important; }

    /* Cache les boutons pré-programmés */
    #btnServiceOK,
    #btnPreviewPopup,
    #btnDownload { display:none !important; }

    /* Cache toute la zone GitHub (inputs toujours présents) */
    .gh-zone { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="icon-192.png" alt="Logo" />
        <div>
          <h1>Apéro Status Admin</h1>
          <div class="small">
            Pilote <code class="inline">status.json</code> (panne, incident, météo, sécurité)
            et publie directement sur APERO DE NUIT 66® et APERO CATALAN®.
          </div>
        </div>
      </div>

      <div class="badge">
        <span>État :</span> <b id="pActive">—</b>
        <span style="opacity:.5">•</span>
        <span>Mode :</span> <b id="pMode">—</b>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="hd"><div class="small">Contrôle</div></div>
        <div class="bd">

          <div class="row">
            <div>
              <label>Statut global</label>
              <select id="active">
                <option value="false">Inactif (aucun pop-up)</option>
                <option value="true">Actif (pop-up affiché)</option>
              </select>
            </div>
            <div>
              <label>Situation</label>
              <select id="mode"></select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Titre</label>
              <input id="title" placeholder="Ex: Service temporairement suspendu" />
            </div>
            <div>
              <label>Niveau</label>
              <select id="severity">
                <option value="info">info</option>
                <option value="warning">warning</option>
                <option value="danger">danger</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Message</label>
            <textarea id="message" placeholder="Texte affiché dans le pop-up..."></textarea>
          </div>

          <div style="margin-top:10px">
            <label>Image (chemin local dans le dépôt status)</label>
            <input id="image" placeholder="images/panne.png" />
          </div>

          <div class="hr"></div>

          <!-- Boutons techniques (présents mais cachés) -->
          <div class="btns">
            <button class="ok" id="btnServiceOK">Préparer “service OK”</button>
            <button class="secondary" id="btnPreviewPopup">Prévisualiser le pop-up</button>
            <button id="btnDownload">Télécharger status.json</button>
          </div>

          <div class="hr"></div>

          <!-- Zone GitHub (présente mais cachée, app.js OK) -->
          <div class="gh-zone">
            <div class="row">
              <div>
                <label>Dépôt GitHub</label>
                <div style="display:flex;gap:10px">
                  <input id="ghOwner" placeholder="bullyto" />
                  <input id="ghRepo" placeholder="status" />
                </div>
              </div>
              <div>
                <label>Branch</label>
                <input id="ghBranch" placeholder="main" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Chemin du fichier</label>
              <input id="ghPath" placeholder="status.json" />
            </div>

            <div style="margin-top:10px">
              <label>Token GitHub</label>
              <input id="ghToken" type="password" autocomplete="off" />
              <div class="small" style="opacity:.7;margin-top:6px">
                Stockage local (localStorage) sur ce téléphone uniquement.
              </div>
            </div>

            <div class="btns" style="margin-top:12px">
              <button class="secondary" id="btnSaveToken" type="button">Enregistrer le token</button>
              <button class="danger" id="btnClearToken" type="button">Supprimer le token</button>
            </div>
          </div>

          <!-- Seul bouton visible -->
          <div class="btns" style="margin-top:12px">
            <button id="btnPublish">Publier</button>
          </div>

        </div>
      </section>

      <!-- Aperçu -->
      <section class="card preview">
        <div class="hd"><div class="small">Aperçu</div></div>
        <div class="bd">
          <img id="pImg" alt="Aperçu image" src="./images/panne.png" />
          <div class="badge">
            <span>Dernière maj :</span> <b id="pUpdated">—</b>
            <span style="opacity:.5">•</span>
            <span>Severity :</span> <b id="pSev">—</b>
          </div>
          <div id="pTitle" style="margin-top:10px;font-weight:900;font-size:18px">—</div>
          <div id="pMsg" style="margin-top:6px;opacity:.85">—</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Preview overlay -->
  <div id="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:999999; align-items:center; justify-content:center; padding:16px;">
    <div style="max-width:520px; width:100%; background:#111; border:1px solid rgba(255,255,255,.12); border-radius:16px; overflow:hidden;">
      <img id="overlayImg" alt="" style="width:100%; display:block;">
      <div style="padding:14px 14px 16px;">
        <div id="overlayTitle" style="font-size:18px; font-weight:800; margin-bottom:6px;"></div>
        <div id="overlayMsg" style="font-size:14px; line-height:1.35;"></div>
        <button id="overlayBtn" style="margin-top:12px; width:100%;">OK</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ✅ Gestion Token en localStorage (sans aucune clé dans le code) -->
  <script>
  (function(){
    const LS_KEY = "gh_token";

    function showToast(msg){
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.classList.remove("show"), 2200);
    }

    function getTokenInput(){
      return document.getElementById("ghToken");
    }

    // 1) Au chargement : on remplit le champ si un token existe
    window.addEventListener("DOMContentLoaded", () => {
      const input = getTokenInput();
      if (!input) return;

      const saved = localStorage.getItem(LS_KEY);
      if (saved) input.value = saved;

      // 2) Bouton enregistrer
      const btnSave = document.getElementById("btnSaveToken");
      if (btnSave) {
        btnSave.addEventListener("click", () => {
          const val = (input.value || "").trim();
          if (!val) {
            localStorage.removeItem(LS_KEY);
            showToast("Token vide : rien enregistré.");
            return;
          }
          localStorage.setItem(LS_KEY, val);
          showToast("Token enregistré sur ce téléphone ✅");
        });
      }

      // 3) Bouton supprimer
      const btnClear = document.getElementById("btnClearToken");
      if (btnClear) {
        btnClear.addEventListener("click", () => {
          localStorage.removeItem(LS_KEY);
          input.value = "";
          showToast("Token supprimé ✅");
        });
      }
    });
  })();
  </script>

  <script src="./app.js"></script>

  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
  </script>
</body>
</html>
